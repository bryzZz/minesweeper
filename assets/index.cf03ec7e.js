var R=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var v=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)};var m=(r,e,t)=>(R(r,e,"access private method"),t);const $=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}};$();function M(r,e){const t=r-.5+Math.random()*(e-r+1);return Math.round(t)}class z{constructor(e){this.name=e,this.callbacks=[]}registerCallback(e){this.callbacks.push(e)}}class G{constructor(){this.events={}}registerEvent(e){e in this.events&&delete this.events[e];const t=new z(e);this.events[e]=t}dispatchEvent(e,t){this.events[e].callbacks.forEach(s=>{s(t)})}addEventListener(e,t){this.events[e].registerCallback(t)}}const g=new G;function A({tagName:r,className:e,textContent:t,attributes:s,styles:i}){const n=document.createElement(r);if(t&&(n.textContent=t),e&&(Array.isArray(e)?n.classList.add(...e):n.classList.add(e)),s)for(const[l,a]of Object.entries(s))n.setAttribute(l,a);return i&&Object.assign(n.style,i),n}var T,K,O,_,w,S,C,F,b,V,H,J,x,Q,L,B,P,Z;class U{constructor(e){v(this,T);v(this,O);v(this,w);v(this,C);v(this,b);v(this,H);v(this,x);v(this,L);v(this,P);this.options=e,this.matrix=m(this,T,K).call(this),this.isFirstClick=!0,this.highlightedCellCoords=null}getMatrix(){return this.matrix}getOptions(){return this.options}getMinesNumber(){let e=0;return m(this,w,S).call(this,t=>{t.isFlag&&(e+=1)}),this.options.minesCount-e}leftClickHandler(e){let t=null;if(m(this,w,S).call(this,d=>{d.id===e&&(t=d)}),this.isFirstClick){const d=[t,...m(this,C,F).call(this,t.y,t.x)];m(this,O,_).call(this,d),this.isFirstClick=!1}const{isOpen:s,isMine:i,isFlag:n,number:l}=t;let a=!1;!s&&!n&&!i?(m(this,b,V).call(this,t),g.dispatchEvent("updatefield")):s&&l>0?(m(this,H,J).call(this,t),g.dispatchEvent("updatefield")):!s&&!n&&i&&(m(this,L,B).call(this),a=!0,g.dispatchEvent("updatefield")),!a&&m(this,x,Q).call(this)&&m(this,P,Z).call(this)}rightClickHandler(e){for(let t=0;t<this.matrix.length;t++)for(let s=0;s<this.matrix[t].length;s++){const i=this.matrix[t][s];if(i.id===e){i.isOpen||(i.isFlag=!i.isFlag),g.dispatchEvent("updatefield");break}}}}T=new WeakSet,K=function(){const{rowsCount:e,columnsCount:t}=this.options,s=[];let i=1;for(let n=0;n<e;n++){const l=[];for(let a=0;a<t;a++){const d={y:n,x:a,id:i.toString(),number:0,isOpen:!1,isMine:!1,isFlag:!1,isHighlighted:!1};l.push(d),i++}s.push(l)}return s},O=new WeakSet,_=function(e){const{rowsCount:t,columnsCount:s,minesCount:i}=this.options,n=[];for(let l=0;l<i;l++){let a=M(0,t-1),d=M(0,s-1),o=this.matrix[a][d];for(;n.includes(o)||e.includes(o);)a=M(0,t-1),d=M(0,s-1),o=this.matrix[a][d];n.push(o),o.isMine=!0,m(this,C,F).call(this,o.y,o.x).forEach(h=>{h.number+=1})}},w=new WeakSet,S=function(e){const{matrix:t}=this;for(let s=0;s<t.length;s++)for(let i=0;i<t[s].length;i++)e(t[s][i])},C=new WeakSet,F=function(e,t,s=this.matrix){var n;const i=[];for(let l=-1;l<=1;l++)for(let a=-1;a<=1;a++){if(l===0&&a===0)continue;const d=(n=s==null?void 0:s[e+l])==null?void 0:n[t+a];d&&i.push(d)}return i},b=new WeakSet,V=function(e){!e.isMine&&!e.isFlag&&!e.isOpen?(e.isOpen=!0,e.number===0&&m(this,C,F).call(this,e.y,e.x).forEach(s=>{m(this,b,V).call(this,s)})):e.isMine&&m(this,L,B).call(this)},H=new WeakSet,J=function(e){const t=m(this,C,F).call(this,e.y,e.x);let s=t.reduce((i,{isFlag:n})=>n?++i:i,0);e.number===s&&t.forEach(i=>{i.isFlag||m(this,b,V).call(this,i)})},x=new WeakSet,Q=function(){let e=!0;return m(this,w,S).call(this,t=>{!t.isOpen&&!t.isMine&&(e=!1)}),e},L=new WeakSet,B=function(){m(this,w,S).call(this,e=>{e.isOpen=!0}),g.dispatchEvent("lose")},P=new WeakSet,Z=function(){g.dispatchEvent("win")};const ee=[{title:"flag",src:"data:image/svg+xml,%3C%3Fxml version='1.0' %3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg enable-background='new 0 0 32 32' height='32px' id='Layer_1' version='1.1' viewBox='0 0 32 32' width='32px' xml:space='preserve' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' style='stroke: %23202020; fill: %23202020'%3E%3Cg%3E%3Cpolyline fill='none' points='649,137.999 675,137.999 675,155.999 661,155.999' stroke='%23FFFFFF' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' stroke-width='2' /%3E%3Cpolyline fill='none' points='653,155.999 649,155.999 649,141.999' stroke='%23FFFFFF' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' stroke-width='2' /%3E%3Cpolyline fill='none' points='661,156 653,162 653,156' stroke='%23FFFFFF' stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10' stroke-width='2' /%3E%3C/g%3E%3Cpath d='M23.317,10l5.441-6.349c0.255-0.296,0.313-0.714,0.149-1.069C28.745,2.228,28.391,2,28,2H4C3.448,2,3,2.448,3,3s0.448,1,1,1 h21.826l-4.585,5.349c-0.321,0.375-0.321,0.927,0,1.302L25.826,16H7v-4V7c0-0.552-0.448-1-1-1S5,6.448,5,7v5v5v11H4 c-0.552,0-1,0.447-1,1s0.448,1,1,1h4c0.552,0,1-0.447,1-1s-0.448-1-1-1H7V18h21c0.391,0,0.745-0.228,0.908-0.582 s0.105-0.772-0.149-1.069L23.317,10z' /%3E%3C/svg%3E"},{title:"bomb",src:"data:image/svg+xml,%3Csvg width='120' height='120' viewBox='0 0 120 120' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='75' y='10' width='35' height='100' fill='%23202020'/%3E%3Crect x='110' y='10' width='35' height='100' transform='rotate(90 110 10)' fill='%23202020'/%3E%3Crect x='45' y='110' width='35' height='100' transform='rotate(-180 45 110)' fill='%23202020'/%3E%3Crect x='10' y='110' width='35' height='100' transform='rotate(-90 10 110)' fill='%23202020'/%3E%3Crect x='110' y='35' width='10' height='50' fill='%23202020'/%3E%3Crect y='35' width='10' height='50' fill='%23202020'/%3E%3Crect x='35' y='10' width='10' height='50' transform='rotate(-90 35 10)' fill='%23202020'/%3E%3Crect x='35' y='120' width='10' height='50' transform='rotate(-90 35 120)' fill='%23202020'/%3E%3C/svg%3E%0A"}];class te{constructor(e){this.model=e,this.html=null,this.drawOptions=null,this.icons=[],this.init()}getHtml(){return this.html}bindHandlers({leftClick:e,rightClick:t,longPress:s}){const i=500;let n,l=!1,a=!1,d,o;const h=(u,f)=>{const E=u.getBoundingClientRect();return{x:f.touches[0].clientX-E.left,y:f.touches[0].clientY-E.top}},c=u=>{if(a=!1,u===0)n=setTimeout(()=>{if(!l){const f=this.findCellByCoords(o,d).id;f&&s(f)}a=!0},i);else if(u===2){const f=this.findCellByCoords(o,d).id;f&&t(f)}},p=u=>{if(u===0&&!a&&!l){const f=this.findCellByCoords(o,d).id;f&&e(f)}clearTimeout(n)};this.html.addEventListener("touchstart",u=>{console.log("start"),u.stopPropagation();const f=h(this.html,u);o=f.y,d=f.x,c(0)}),this.html.addEventListener("touchend",u=>{console.log("end"),u.stopPropagation(),p(0),l=!1}),this.html.addEventListener("touchmove",u=>{u.stopPropagation(),l=!0}),this.html.addEventListener("mousedown",u=>{u.stopPropagation(),o=u.offsetY,d=u.offsetX;const f=u.button;c(f)}),this.html.addEventListener("mouseup",u=>p(u.button))}init(){this.html=A({tagName:"canvas",className:"minesweeper-field"}),this.html.oncontextmenu=()=>!1;const{rowsCount:e,columnsCount:t}=this.model.getOptions(),s=2,i=50,n=i*t,l=i*e,a=n*s,d=l*s,o=i*s,h=o*.8,c=h*.6,p=o*.6;this.drawOptions=Object.freeze({colors:{main:"#e77d26",flag:"#646464",mine:"tomato",text:"#e5e5e5",stroke:"rgb(156, 156, 156)"},font:{size:48,family:"Roboto"},rowsCount:e,columnsCount:t,width:n,height:l,cellSize:i,dpi:s,dpiWidth:a,dpiHeight:d,dpiCellSize:o,shownCellSize:h,iconSize:c,linesLength:p}),this.setSizes(),this.preloadIcons(),this.updateView(),this.addCursorMoveEvents(),g.addEventListener("updatefield",this.updateView.bind(this))}setSizes(){const{width:e,height:t,dpiWidth:s,dpiHeight:i}=this.drawOptions;this.html.style.width=e+"px",this.html.style.height=t+"px",this.html.width=s,this.html.height=i}updateView(){const{dpiWidth:e,dpiHeight:t}=this.drawOptions,s=this.model.getMatrix(),i=this.html.getContext("2d");i.clearRect(0,0,e,t),i.beginPath(),this.drawLines(i),this.drawCells(i,s),i.closePath()}drawLines(e){const{rowsCount:t,columnsCount:s,dpiWidth:i,dpiCellSize:n,linesLength:l,dpi:a}=this.drawOptions,d=(i-l*s)/s;e.strokeStyle=this.drawOptions.colors.stroke,e.lineWidth=a/2;for(let o=1;o<t;o++){const h=n*o;for(let c=0;c<s;c++){let p=d/2+c*n;e.moveTo(p,h),e.lineTo(p+l,h)}}for(let o=1;o<s;o++){const h=n*o;for(let c=0;c<t;c++){const p=d/2+c*n;e.moveTo(h,p),e.lineTo(h,p+l)}}e.stroke()}drawCells(e,t){const{dpiCellSize:s,shownCellSize:i}=this.drawOptions,{main:n,flag:l,mine:a}=this.drawOptions.colors;for(let d=0;d<t.length;d++)for(let o=0;o<t[d].length;o++){const{isOpen:h,isFlag:c,isMine:p,number:u}=t[d][o];let f="transparent",E="";h?p&&(f=a,E=this.icons.bomb):(f=n,c&&(f=l,E=this.icons.flag));const q=(s-i)/2+d*s,N=(s-i)/2+o*s,I=i/100*8;let X=u>0&&h&&!p?u:"";e.beginPath(),this.drawCell(e,N,q,i,I,f,X,E),e.closePath()}}drawCell(e,t,s,i,n=5,l,a,d){if(typeof n=="number")n={tl:n,tr:n,br:n,bl:n};else{const o={tl:0,tr:0,br:0,bl:0};for(const h in o)n[h]=n[h]||o[h]}if(e.moveTo(t+n.tl,s),e.lineTo(t+i-n.tr,s),e.quadraticCurveTo(t+i,s,t+i,s+n.tr),e.lineTo(t+i,s+i-n.br),e.quadraticCurveTo(t+i,s+i,t+i-n.br,s+i),e.lineTo(t+n.bl,s+i),e.quadraticCurveTo(t,s+i,t,s+i-n.bl),e.lineTo(t,s+n.tl),e.quadraticCurveTo(t,s,t+n.tl,s),e.fillStyle=l,e.fill(),a){const{colors:{text:o},font:{size:h,family:c}}=this.drawOptions;e.fillStyle=o,e.font=`${h}px ${c}`,e.fillText(a,t+i/2.9,s+i/1.5)}if(d){const{iconSize:o}=this.drawOptions,h=t+(i-o)/2,c=s+(i-o)/2;e.drawImage(d,h,c,o,o)}}preloadIcons(){for(const e of ee){let t=new Image;t.onload=()=>t=this,t.src=e.src,this.icons[e.title]=t}}findCellByCoords(e,t){const{cellSize:s}=this.drawOptions,i=this.model.getMatrix();return e=Math.floor(e/s),t=Math.floor(t/s),i[e][t]}addCursorMoveEvents(){this.html.addEventListener("mousemove",e=>{const t=e.offsetY,s=e.offsetX,i=this.findCellByCoords(t,s);!i||(i.isOpen?this.html.style.cursor="default":this.html.style.cursor="pointer")})}}class ie{constructor(e){this.options=e,this.model=null,this.view=null,this.loseCallback=null,this.winCallback=null}start(){g.registerEvent("updatefield"),g.registerEvent("lose"),g.registerEvent("win"),g.addEventListener("lose",()=>this.loseCallback()),g.addEventListener("win",()=>this.winCallback()),this.model=new U(this.options),this.view=new te(this.model),this.view.bindHandlers({leftClick:e=>this.model.leftClickHandler(e),rightClick:e=>this.model.rightClickHandler(e),longPress:e=>this.model.rightClickHandler(e)})}getView(){return this.view}onLose(e){this.loseCallback=e}onWin(e){this.winCallback=e}onMinesCounterChange(e){let t=this.model.getMinesNumber();e(t),g.addEventListener("updatefield",()=>{t=this.model.getMinesNumber(),e(t)})}}let y=new ie({rowsCount:10,columnsCount:10,minesCount:9});const D=document.querySelector("#app"),j=D.querySelector(".header"),k=D.querySelector(".container");function W(r){var s;r.innerHTML="",y.start();const e=y.getView().getHtml();r.append(e),(s=j.querySelector(".mines-counter"))==null||s.remove();const t=A({tagName:"div",className:"mines-counter"});y.onMinesCounterChange(i=>{t.innerHTML=`Mines left: ${i}`}),j.append(t)}W(k);const se=ne(k);function ne(r){const e=y.getView().getHtml();let t={top:0,left:0,x:0,y:0},s=!1,i=!1;document.addEventListener("keydown",n),document.addEventListener("keyup",l),r.addEventListener("mousedown",a);function n(c){c.code==="Space"&&(c.preventDefault(),i=!0,s||(r.style.cursor="grab"),e.classList.add("no-pointer-events"))}function l(c){c.code==="Space"&&(i=!1,s||(r.style.cursor="default",e.classList.remove("no-pointer-events")))}function a(c){i&&(s=!0,r.style.cursor="grabbing",t={left:r.scrollLeft,top:r.scrollTop,x:c.clientX,y:c.clientY},r.addEventListener("mousemove",d),r.addEventListener("mouseup",o))}function d(c){const p=c.clientX-t.x,u=c.clientY-t.y;r.scrollTop=t.top-u,r.scrollLeft=t.left-p}function o(){r.removeEventListener("mousemove",d),r.removeEventListener("mouseup",o),s=!1,i||(r.style.cursor="default",e.classList.remove("no-pointer-events"))}function h(){document.removeEventListener("keydown",n),document.removeEventListener("keyup",l),r.removeEventListener("mousedown",a)}return h}y.onWin(()=>Y("You Win!","win"));y.onLose(()=>Y("You Lose","lose"));function Y(r,e){se();const t=A({tagName:"div",className:["end-screen",e]});t.innerHTML=`
        <div>${r}</div>
        <div>Click any button to restart</div>
    `;const s=()=>{W(k),t.removeEventListener("click",s),document.removeEventListener("keypress",s),t.remove()};t.addEventListener("mousedown",s),document.addEventListener("keypress",s),k.append(t),k.classList.toggle("overflow-hidden")}
